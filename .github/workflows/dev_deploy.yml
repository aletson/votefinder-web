on: push
name: Nonprod CI
jobs:
  cicd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Lint
        uses: wemake-services/wemake-python-styleguide@0.13.3
      - name: Deploy to Dev
        if: ${{ success() && github.ref == 'refs/heads/master' && github.event_name == 'push' }}
        uses: easingthemes/ssh-deploy@v2.1.1
        env: 
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          TARGET: ${{ secrets.DEV_TARGET }}
      - name: Verify database connection
        if: ${{ success() && github.ref == 'refs/heads/master' && github.event_name == 'push' }}
        env:
          MYSQL_SERVER: ${{ secrets.MYSQL_SERVER }}
        run: |
          mysqladmin ping -h $MYSQL_SERVER --silent
          if [ $? -ne 0 ]; then
            exit 1
          fi
      - name: Run migrations
        if: ${{ success() && github.ref == 'refs/heads/master' && github.event_name == 'push' }}
        env:
          MYSQL_SERVER: ${{ secrets.MYSQL_SERVER }}
          DEV_DBUSER: ${{ secrets.DEV_DBUSER }}
          DEV_DBPASSWD: ${{ secrets.DEV_DBPASSWD }}
          DEV_DBNAME: ${{ secrets.DEV_DBNAME }}
        run: |
          MIGRATION=`mysql -h $MYSQL_SERVER -u $DEV_DBUSER -p$DEV_DBPASSWD $DEV_DBNAME -e "SELECT version FROM migration_version" -sN`
          if [ MIGRATION -eq 0 ]; then
            exit 1
          fi
          MIGRATION=$((MIGRATION+1))
          while [ -f sql/migration_$MIGRATION.sql ]; do
            echo "Applying migration to $MIGRATION..."
            mysql -h $secrets.MYSQL_SERVER -u $DEV_DBUSER -p$DEV_DBPASSWD $DEV_DBNAME < sql/migration_$MIGRATION.sql
            if [ $? -ne 0 ]; then
              echo "Error detected on migration!"
              exit 1
            fi
            MIGRATION=$((MIGRATION+1))
          done
